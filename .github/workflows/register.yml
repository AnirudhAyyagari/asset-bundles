name: Databricks ML Model CI/CD (Single Environment)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches:
      - main
  push:
    branches:
      - main

jobs:
  # ==========================================
  # PR WORKFLOW: Validation & Model Registration
  # ==========================================
  validate-bundle:
    name: Validate Bundle Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Validate Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üîç Validating Databricks bundle configuration..."
          databricks bundle validate --target=default
          echo "‚úÖ Bundle validation passed successfully"

  deploy-bundle:
    name: Deploy Databricks Asset Bundle
    needs: validate-bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Deploy Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üì¶ Deploying Databricks asset bundle..."
          databricks bundle deploy --target=default
          echo "‚úÖ Bundle deployed successfully"

  register-model:
    name: Register Model
    needs: deploy-bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Trigger Model Registration Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üöÄ Starting model registration job..."
          databricks bundle run Banking_Model_Register --target=default
          echo "‚úÖ Model registration completed"
          echo "üìù Model is now registered and ready for inference"

  # ==========================================
  # PUSH WORKFLOW: Run Inference on Merge
  # ==========================================
  run-inference:
    name: Run Batch Inference Job
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Trigger Inference Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üöÄ Starting inference job on main branch..."
          databricks bundle run Banking_Default_Inference --target=default
          echo "‚úÖ Inference completed successfully"
          echo "üìä Check Databricks workspace for inference results"