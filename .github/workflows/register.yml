name: Databricks ML Model CI/CD (Dev + Prod)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches:
      - main
  push:
    branches:
      - main

env:
  DEV_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
  DEV_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
  PROD_HOST: ${{ secrets.DATABRICKS_HOST_PROD }}
  PROD_TOKEN: ${{ secrets.DATABRICKS_TOKEN_PROD }}

jobs:
  # ==========================================
  # PR WORKFLOW: Validation & Model Registration (DEV)
  # ==========================================
  validate-bundle:
    name: Validate Bundle (Dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Validate Bundle (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          echo "üîç Validating Databricks bundle configuration in DEV..."
          databricks bundle validate --target=default
          echo "‚úÖ Bundle validation passed successfully in DEV"

  deploy-bundle:
    name: Deploy Databricks Asset Bundle (Dev)
    needs: validate-bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Deploy Bundle (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          echo "üì¶ Deploying Databricks asset bundle to DEV..."
          databricks bundle deploy --target=default
          echo "‚úÖ Bundle deployed successfully in DEV"

  register-model:
    name: Register Model (Dev)
    needs: deploy-bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Trigger Model Registration Job (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          echo "üöÄ Starting model registration job in DEV..."
          databricks bundle run Banking_Model_Register --target=default
          echo "‚úÖ Model registration completed in DEV"
          echo "üìù Model is now registered and ready for inference"

  # ==========================================
  # PUSH WORKFLOW: Deploy, Register, Inference (PROD)
  # ==========================================
  validate-bundle-prod:
    name: Validate Bundle (Prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Validate Bundle (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          echo "üîç Validating Databricks bundle configuration in PROD..."
          databricks bundle validate --target=prod
          echo "‚úÖ Bundle validation passed successfully in PROD"

  deploy-bundle-prod:
    name: Deploy Databricks Asset Bundle (Prod)
    needs: validate-bundle-prod
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy Bundle (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          echo "üì¶ Deploying Databricks asset bundle to PROD..."
          databricks bundle deploy --target=prod
          echo "‚úÖ Bundle deployed successfully in PROD"

  register-model-prod:
    name: Register Model (Prod)
    needs: deploy-bundle-prod
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Trigger Model Registration Job (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          echo "üöÄ Starting model registration job in PROD..."
          databricks bundle run Banking_Model_Register --target=prod
          echo "‚úÖ Model registration completed in PROD"

  run-inference-prod:
    name: Run Batch Inference Job (Prod)
    needs: register-model-prod
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Trigger Inference Job (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          echo "üöÄ Starting inference job in PROD..."
          databricks bundle run Banking_Default_Inference --target=prod
          echo "‚úÖ Inference completed successfully in PROD"
          echo "üìä Check Databricks PROD workspace for inference results"