name: Databricks ML Model CI/CD (Dev + Prod with Approval)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches:
      - main
  push:
    branches:
      - main

env:
  DEV_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
  DEV_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
  PROD_HOST: ${{ secrets.DATABRICKS_HOST_PROD }}
  PROD_TOKEN: ${{ secrets.DATABRICKS_TOKEN_PROD }}

jobs:
  # ============================
  # PHASE 1 (PR): DEV PATH
  # ============================
  validate-bundle:
    name: Validate Bundle (Dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Validate Bundle (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          databricks bundle validate --target=default

  deploy-bundle:
    name: Deploy Bundle (Dev)
    needs: validate-bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Deploy Bundle (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          databricks bundle deploy --target=default

  register-model-dev:
    name: Register Model (Dev)
    needs: deploy-bundle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Register Trained Model (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          databricks bundle run Banking_Model_Register --target=default

  run-inference-dev:
    name: Run Inference (Dev)
    needs: register-model-dev
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Trigger Inference (Dev)
        env:
          DATABRICKS_HOST: ${{ env.DEV_HOST }}
          DATABRICKS_TOKEN: ${{ env.DEV_TOKEN }}
        run: |
          databricks bundle run Banking_Default_Inference --target=default

  manual-approval:
    name: Manual Approval Before Prod
    needs: run-inference-dev
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment:
      name: dev-validation   # create this Environment in repo settings with required reviewers
    steps:
      - run: |
          echo "Waiting for approval: review DEV results, then approve to promote to PROD (validate/deploy/register)."

  # ============================
  # PHASE 1 (PR): PROD PROMOTION (NO INFERENCE)
  # ============================
  validate-bundle-prod-pr:
    name: Validate Bundle (Prod)
    needs: manual-approval
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Validate Bundle (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          databricks bundle validate --target=prod

  deploy-bundle-prod-pr:
    name: Deploy Bundle (Prod)
    needs: validate-bundle-prod-pr
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Deploy Bundle (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          databricks bundle deploy --target=prod

  register-model-prod-pr:
    name: Register Model (Prod)
    needs: deploy-bundle-prod-pr
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Trigger Model Registration (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          databricks bundle run Banking_Model_Register --target=prod
      # STOP HERE on PR. No prod inference in PR phase.

  # ============================
  # PHASE 2 (MERGE): PROD INFERENCE ONLY
  # ============================
  run-inference-prod:
    name: Run Inference (Prod)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      - name: Trigger Inference (Prod)
        env:
          DATABRICKS_HOST: ${{ env.PROD_HOST }}
          DATABRICKS_TOKEN: ${{ env.PROD_TOKEN }}
        run: |
          databricks bundle run Banking_Default_Inference --target=prod
