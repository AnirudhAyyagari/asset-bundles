name: Databricks ML Model CI/CD (PR Trigger)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches:
      - main

jobs:
  # ==================================
  # NEW: VALIDATION STEP
  # ==================================
  validate-bundle:
    name: Validate Bundle Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Validate Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üîç Validating Databricks bundle configuration..."
          databricks bundle validate --target=default
          echo "‚úÖ Bundle validation passed successfully"

  # ==================================
  # EXISTING JOBS (UNCHANGED)
  # ==================================
  deploy-bundle:
    name: Deploy Databricks Asset Bundle
    needs: validate-bundle  # Only deploy if validation passes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Deploy Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Validating and deploying Databricks asset bundle..."
          databricks bundle validate
          databricks bundle deploy --target=default
          echo "‚úÖ Bundle deployed successfully."

  register-model:
    name: Run Model Registration
    needs: deploy-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Trigger Model Registration Job
        id: register
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üöÄ Starting model registration job..."
          databricks bundle run Banking_Model_Register --target=default
          echo "‚úÖ Model registration completed."

  manual-approval:
    name: Manual Model Validation
    needs: register-model
    runs-on: ubuntu-latest
    environment: production
    steps:
      - run: echo "‚è∏Ô∏è Waiting for manual approval (reviewer must approve in GitHub)."

  run-inference:
    name: Run Batch Inference Job
    needs: manual-approval
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      
      - name: Trigger Inference Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "üöÄ Starting inference job..."
          databricks bundle run Banking_Default_Inference --target=default
          echo "‚úÖ Inference completed successfully."